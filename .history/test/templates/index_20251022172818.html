<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>数据准备与整合</title>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
body { font-family: "Microsoft YaHei", sans-serif; background: #f0f2f5; margin: 0; padding: 20px;}
h2 { margin-bottom: 10px;}
table { border-collapse: collapse; width: 100%; background: #fff; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background: #eee; }
button { padding: 4px 8px; margin: 2px; cursor: pointer; }
#previewModal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5);}
#previewContent { background: #fff; margin: 50px auto; padding: 20px; width: 80%; max-height: 80%; overflow: auto;}
</style>
</head>
<body>
<h2>站点数据管理</h2>
<table id="sitesTable">
    <thead>
        <tr>
            <th>站点编号</th>
            <th>PWV</th>
            <th>气象</th>
            <th>雨量筒</th>
            <th>合并数据</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- 预览弹窗 -->
<div id="previewModal">
    <div id="previewContent">
        <h3>数据预览</h3>
        <button onclick="closePreview()">关闭</button>
        <table id="previewTable">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>t2m</th>
                    <th>sp</th>
                    <th>rh</th>
                    <th>pwv</th>
                    <th>tp</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
// 获取站点状态并渲染表格
async function loadSites() {
    try {
        const res = await axios.get('/get_datasets');
        const tbody = document.querySelector('#sitesTable tbody');
        tbody.innerHTML = '';
        res.data.forEach(site => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${site.site_id}</td>
                <td>${site.pwv ? '✔' : '✘'}</td>
                <td>${site.weather ? '✔' : '✘'}</td>
                <td>${site.rain ? '✔' : '✘'}</td>
                <td>${site.merged.map(f => `<button onclick="previewFile('${site.site_id}','${f}')">${f}</button>`).join(' ')}</td>
                <td><button onclick="deleteSite('${site.site_id}')">删除站点</button></td>
            `;
            tbody.appendChild(tr);
        });
    } catch(e) {
        alert('获取站点数据失败: ' + e);
    }
}

// 删除站点
async function deleteSite(site) {
    if(!confirm(`确认删除站点 ${site} 吗？`)) return;
    try {
        const res = await axios.delete(`/delete_dataset/${site}`);
        if(res.data.success){
            alert('删除成功');
            loadSites();
        } else {
            alert('删除失败: ' + res.data.error);
        }
    } catch(e) {
        alert('删除失败: ' + e);
    }
}

// 预览 CSV 文件
async function previewFile(site, filename) {
    try {
        const res = await axios.get(`/tmp_data_preview/${filename}/${site}`);
        const tbody = document.querySelector('#previewTable tbody');
        tbody.innerHTML = '';
        res.data.rows.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.date||''}</td>
                <td>${row.t2m||''}</td>
                <td>${row.sp||''}</td>
                <td>${row.rh||''}</td>
                <td>${row.pwv||''}</td>
                <td>${row.tp||''}</td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('previewModal').style.display = 'block';
    } catch(e) {
        alert('预览失败: ' + e);
    }
}

// 关闭预览弹窗
function closePreview() {
    document.getElementById('previewModal').style.display = 'none';
}

// 页面加载
window.onload = loadSites;
</script>
</body>
</html>
